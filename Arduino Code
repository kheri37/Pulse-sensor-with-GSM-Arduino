#include <SoftwareSerial.h>

//Create software serial object to communicate with SIM800L
SoftwareSerial mySerial(5,4); //SIM800L Tx & Rx is connected to Arduino #8 & #9

// include the library code:
#include <LiquidCrystal.h>
#define USE_ARDUINO_INTERRUPTS true    // Set-up low-level interrupts for most acurate BPM math
#include <PulseSensorPlayground.h>     // Includes the PulseSensorPlayground Library

const int PulseWire = 0;       // 'S' Signal pin connected to A0
const int LED13 = 13;          // The on-board Arduino LED
int Threshold = 550;           // Determine which Signal to "count as a beat" and which to ignore
int results;             
PulseSensorPlayground pulseSensor;  // Creates an object

// initialize the library by associating any needed LCD interface pin
// with the arduino pin number it is connected to
const int rs =8, en = 9, d4 = 10, d5 = 11, d6 = 12, d7 = 13;
LiquidCrystal lcd(rs, en, d4, d5, d6, d7);

void setup() {
  // set up the LCD's number of columns and rows:
  
  Serial.begin(9600);
  //Begin serial communication with Arduino and Arduino IDE (Serial Monitor)
  
  //Begin serial communication with Arduino and SIM800L
   mySerial.begin(9600);
  lcd.begin(16, 2);
  lcd.clear();
  lcd.setCursor(5,0);
  lcd.print("SYSTEM");
  lcd.setCursor(1,1);
  lcd.print("INITIALISING");
  delay(1000);
  Serial.println("Initializing..."); 
  delay(1000);
  
 

  // Configure the PulseSensor object, by assigning our variables to it
  pulseSensor.analogInput(PulseWire);   
  pulseSensor.blinkOnPulse(LED13);       // Blink on-board LED with heartbeat
  pulseSensor.setThreshold(Threshold);   

  // Double-check the "pulseSensor" object was created and began seeing a signal
  if (pulseSensor.begin()) {
    Serial.println("PulseSensor object created!");
  }
 
}

void loop() {
 
 
  int myBPM = pulseSensor.getBeatsPerMinute();      // Calculates BPM

  if (pulseSensor.sawStartOfBeat()) {  // Constantly test to see if a beat happened
    results=myBPM-150;
    Serial.println("â™¥  A HeartBeat Happened ! "); // If true, print a message
    Serial.print("BPM: ");
    Serial.println(results);                        // Print the BPM value
    }
    if(results<70){
      lcd.clear();
      lcd.setCursor(0,0);
      lcd.print("HEART MONITORING");
      lcd.setCursor(0,1);
      lcd.print("STATUS: GOOD");
      mySerial.println("ATH"); //hang up
      updateSerial();
    }else if(results>70){
      lcd.clear();
      lcd.setCursor(0,0);
      lcd.print("HEART MONITORING");
      lcd.setCursor(0,1);
      lcd.print("STATUS: BAD"); 
      mySerial.println("AT"); //Once the handshake test is successful, i t will back to OK
      updateSerial();
      mySerial.println("ATD+ +254748613509;"); //  change ZZ with country code and xxxxxxxxxxx with phone number to dial
      updateSerial();
      delay(100); // wait for 20 seconds...
     
      
     
    }
   
    
 }
void updateSerial()
{
  delay(500);
  while (Serial.available()) 
  {
    mySerial.write(Serial.read());//Forward what Serial received to Software Serial Port
  }
  while(mySerial.available()) 
  {
    Serial.write(mySerial.read());//Forward what Software Serial received to Serial Port
  }
}
